var App=window.App=angular.module("WeatherApp",["ngAnimate","angularMoment","slugifier"]);App.constant("DEFAULT_LOCATION","Los Angeles, United States"),App.constant("API_ENDPOINTS",{url:"https://query.yahooapis.com",query:"/v1/public/yql"}),App.constant("GEO_IP_URL","https://freegeoip.net");var App=angular.module("WeatherApp");App.factory("YQL",["API_ENDPOINTS","GeoPosition",function(t,o){var e=function(t,e,r){switch(o.validate(e)&&(e="("+e+")"),t){case"weather":return i(e,r);case"location":return n(e,r);default:throw new Error("unrecognized query type:"+t)}},n=function(t,o){var o=o||["woeid","name","country","admin1","admin2","locality1","locality2","centroid"],e=["select "+o.join(","),"from geo.places(1)",'where text="'+t+'"'].join(" ");return e},i=function(t,o){var o=o||["*"],e=["select "+o.join(","),"from weather.forecast","where woeid in (","select woeid from geo.places(1)",'where text="'+t+'" limit 1',') and u="c" limit 1'].join(" ");return e};return{queryFor:e}}]),App.factory("PlaceFinder",["API_ENDPOINTS","$http","GeoPosition",function(t,o,e){var n=t.url+t.query,i=function(t){return{coords:{latitude:t.place.centroid.latitude,longitude:t.place.centroid.longitude},timestamp:new Date,info:{id:t.place.woeid,country:{code:t.place.country.code,name:t.place.country.content},region:{code:t.place.admin1.code,name:t.place.admin1.content},county:t.place.admin2?t.place.admin2.content:null,city:t.place.locality1?t.place.locality1.content:null,suburb:t.place.locality2?t.place.locality2.content:null}}},r=function(t){var r=YQL.queryFor("location",place),a={params:{q:r,format:"json"}};return o.get(n,a).then(function(t){var o=t.data.query.results;return new e(i(o))},function(t){return t})};return{find:r}}]),App.factory("Weather",["$http","API_ENDPOINTS","YQL",function(t,o,e){var n=o.url+o.query,i=function(t){var o={},e={latitude:t.item.lat,longitude:t.item["long"]};return o.date=new Date,o.units=t.units,o.location=angular.extend({},t.location,e),today_forecast=t.item.forecast[0],today_temps={high:today_forecast.high,low:today_forecast.low},o.today={wind:t.wind,atmosphere:t.atmosphere,condition:angular.extend({},t.item.condition,today_temps)},o.week=t.item.forecast.slice(1),o},r=function(o){var r=e.queryFor("weather",o),a={params:{q:r,format:"json"}};return t.get(n,a).then(function(t){return i(t.data.query.results.channel)},function(t){console.error(t)})},a=function(o,e){var r=getYql([o,e].join(","));return t.get(n,{params:{q:r,format:"json"}}).then(function(t){return i(t.data.query.results.channel)},function(t){console.error(t)})};return{forecastFor:r,forecastForLocation:a}}]),App.factory("IPLocator",["GEO_IP_URL","$http",function(t,o){var e=function(o){this.url=t};return e.getCurrentPosition=function(t,e){return o.get(this.url+"/json").then(function(o){t({coords:{latitude:o.latitude,longitude:o.longitude},timestamp:new Date})},function(t){e({code:"",message:t})})},e}]),App.factory("Geolocation",["GeoPosition","IPLocator","$q",function(t,o,e){var n="undefined"!=typeof navigator.geolocation&&null!==navigator.geolocation,i=function(){n?this.locator=navigator.geolocation:this.locator=IPGeolocator};return i.GEOLOCATION_PROVIDERS={},i.LOCATION_TIMEOUT=5e3,i.prototype.current=function(){var n=this,r=e(function(e,r){n.locator.getCurrentPosition(function(o){var n=new t({coords:o.coords,timestamp:o.timestamp});e(n)},function(t){var e="";switch(t.code){case t.PERMISSION_DENIED:e="You denied permission for geolocation. Falling back to IP based location",n.switchGeolocationProviderTo(o);break;case t.POSITION_UNAVAILABLE:e="We couldn't find you on the map.";break;case t.TIMEOUT:e="Sorry! we ran out of time localizing you.";break;case t.UNKNOWN_ERROR:default:e="An unknown error occurred."}r({code:t.code,message:e})},{timeout:i.LOCATION_TIMEOUT})});return r},i.prototype.switchGeolocationProviderTo=function(t){this.locator=t},i.prototype.getGeolocationProvider=function(){return this.locator},i}]),App.factory("GeoPosition",function(){var t=/^(-?\d+\.\d+),\s?(-?\d+\.\d+)$/,o=function(t,o){this.latitude=parseFloat(t.coords.latitude),this.longitude=parseFloat(t.coords.longitude),this.info=t.info,this.timestamp=o};return o.validate=function(o){return o.match(t)},o.prototype.toString=function(){return this.info.city.name+", "+this.info.state.name+", "+this.info.country.name},o.prototype.setCoordinates=function(t,o){this.latitude=t,this.longitude=o},o});var App=angular.module("WeatherApp");App.controller("ApplicationController",["$scope",function(t){t.loading=!0,t.$on("loading:toggle",function(o){t.loading=!t.loading})}]),App.controller("WeatherWidgetController",["$scope","PlaceFinder","Weather","Geolocation","DEFAULT_LOCATION",function(t,o,e,n,i){this.isPopupOen=!1,this.init=function(){e.forecastFor(i).then(function(o){t.forecast=o,t.$emit("loading:toggle")})},this.togglePopup=function(){this.isPopupOpen=!this.isPopupOpen},this.getForecast=function(o,n){e.forecastForLocation(o,n).then(function(o){t.forecast=o,t.$emit("loading:toggle")}),t.$emit("loading:toggle"),this.togglePopup()},this.findPlace=function(e){o.find(e).then(function(o){o instanceof Array?t.places=o:t.places=[o]},function(t){console.error(t)})},this.init()}]);